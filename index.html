<!DOCTYPE html>
<html>
<head>
    <title>AU Emergency Check</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; line-height: 1.4; padding: 10px; background: #f4f4f4; }
        .box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .warn { color: white; background: #d32f2f; padding: 10px; border-radius: 4px; font-weight: bold; display: none; }
        pre { background: #eee; padding: 5px; font-size: 12px; overflow-x: auto; }
        input { width: 60px; }
    </style>
</head>
<body>

    <div class="box">
        <b>AU Fire & Heat Risk</b><br>
        Lat: <input id="lat" type="text"> 
        Lon: <input id="lon" type="text">
        <button onclick="fetchData()">Go</button>
        <button onclick="getLocation()">GPS</button>
        <p id="status" style="margin:5px 0; font-size: 12px;"></p>
    </div>

    <div id="alertBox" class="warn"></div>

    <div class="box">
        <pre id="output">No data loaded.</pre>
    </div>

    <div style="font-size:10px; color:#666;">
        <b>AFDRS Index:</b> 0-23: Mod | 24-49: High | 50-99: Extreme | 100+: Catastrophic
    </div>

<script>
    const storage = localStorage;
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const alertBox = document.getElementById('alertBox');

    // Load saved coords
    latInput.value = storage.getItem('last_lat') || '';
    lonInput.value = storage.getItem('last_lon') || '';

    function getLocation() {
        status.innerText = "Locating...";
        navigator.geolocation.getCurrentPosition(pos => {
            latInput.value = pos.coords.latitude.toFixed(2);
            lonInput.value = pos.coords.longitude.toFixed(2);
            fetchData();
        }, () => { status.innerText = "GPS Error"; });
    }

    async function fetchData() {
        const x = latInput.value;
        const y = lonInput.value;
        if(!x || !y) return status.innerText = "Need Coords";

        // Save coords
        storage.setItem('last_lat', x);
        storage.setItem('last_lon', y);
        status.innerText = "Fetching...";
        alertBox.style.display = 'none';

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${x}&longitude=${y}&daily=fire_danger_index,temperature_2m_max&timezone=auto`;
            const response = await fetch(url);
            const data = await response.json();

            if(!data.daily) throw new Error("Invalid API Response");

            render(data);
            status.innerText = "Updated: " + new Date().toLocaleTimeString();
        } catch (e) {
            status.innerText = "Error: " + e.message;
        }
    }

    function render(data) {
        const daily = data.daily;
        let text = "7-DAY OUTLOOK\nDATE    IDX    TEMP    RATING\n------------------------------\n";
        
        daily.time.forEach((date, i) => {
            const fwi = Math.round(daily.fire_danger_index[i]);
            const temp = Math.round(daily.temperature_2m_max[i]);
            const day = date.split('-')[2];

            let rating = "MOD";
            if(fwi >= 100) rating = "CATASTROPHIC";
            else if(fwi >= 50) rating = "EXTREME";
            else if(fwi >= 24) rating = "HIGH";

            text += `${day}      ${fwi.toString().padEnd(3)}    ${temp}°C    ${rating}\n`;

            // Trigger alert if today is Extreme or higher
            if(i === 0 && fwi >= 50) {
                alertBox.innerText = `⚠️ DANGER: ${rating} FIRE RISK TODAY`;
                alertBox.style.display = 'block';
            }
        });

        output.innerText = text;
    }
</script>
</body>
</html>
